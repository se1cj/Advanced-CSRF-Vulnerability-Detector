from bs4 import BeautifulSoup
import os
import re

# كشف رمز CSRF من أنواع متعددة
def detect_csrf_tokens(file_path):
    with open(file_path, 'r') as f:
        soup = BeautifulSoup(f, 'html.parser')
        
        # الكشف عن أنواع مختلفة من الرموز
        token_names = ['_csrf_token', 'csrfmiddlewaretoken', '__RequestVerificationToken']
        tokens = []
        
        # البحث في عناصر الإدخال (input)
        for token_name in token_names:
            tokens += soup.find_all('input', {'name': token_name})

        # البحث عن الرموز المخبأة في نصوص JavaScript
        script_tags = soup.find_all('script')
        for script in script_tags:
            if script.string:
                matches = re.findall(r"['\"]csrf['\"]\s*:\s*['\"](\w+)['\"]", script.string)
                tokens += matches

        return tokens

# فحص مجلد كامل
def scan_directory(directory):
    findings = {}
    for filename in os.listdir(directory):
        if filename.endswith('.html'):
            tokens = detect_csrf_tokens(os.path.join(directory, filename))
            findings[filename] = {'tokens_found': len(tokens), 'tokens': [token['name'] for token in tokens if isinstance(token, dict)]}
    return findings
