from flask import Flask, jsonify, request
from detector.csrf_token_finder import scan_directory

app = Flask(__name__)

@app.route('/scan', methods=['GET'])
def scan():
    directory = request.args.get('directory')
    if not directory:
        return jsonify({"error": "Directory parameter is required"}), 400

    findings = scan_directory(directory)
    return jsonify(findings)

@app.route('/upload', methods=['POST'])
def upload_and_scan():
    # معالجة ملفات HTML المحملة عبر API
    uploaded_files = request.files.getlist("files")
    if not uploaded_files:
        return jsonify({"error": "No files uploaded"}), 400

    findings = {}
    for file in uploaded_files:
        file_path = os.path.join("uploaded_files", file.filename)
        file.save(file_path)
        findings[file.filename] = detect_csrf_tokens(file_path)
    
    return jsonify(findings)

if __name__ == "__main__":
    app.run(debug=True)
